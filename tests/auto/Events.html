<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Plupload: Test Uploader Events</title>

<script src="../loader.js"></script>

<script type="text/javascript">

QUnit.config.reorder = false;
QUnit.config.autostart = false;
QUnit.config.testTimeout = 10000;

FileHash.init({
	files: ['files/01.min.js', 'files/02.min.js'],
	onready: function() {
		QUnit.start();
	}
});

plupload.ua.swf_url = "../../js/flash/Moxie.swf";
plupload.ua.xap_url = "../../js/silverlight/Moxie.xap";

module("Methods", {
	setup: function() {
		var options, up;

		$('#qunit-fixture').html('<div id="uploader" />');

		options = this.options = {
			browse_button: 'uploader',
			container: 'qunit-fixture',
			url: "Plupload/upload.php"
		};

		up = this.up = new plupload.Uploader(options);

		up.bind('PostInit', function() {
			QUnit.start();
		});

		QUnit.stop();
		up.init();
	},

	teardown: function() {
		this.up.destroy();
	}
});


test("trigger()", function(assert) {
	var up = this.up, arg1 = 1, arg2 = { two: 2 };

	up.bind('SomeEvent', function(up, one, two) {
		ok(up instanceof plupload.Uploader, "First argument is always plupload.Uploader instance.");
		deepEqual(one, arg1, "Second argument (number) successfully passed.");
		deepEqual(two, arg2, "Thir argument (object) successfully passed.");
	});

	up.trigger('SomeEvent', arg1, arg2);
});


test("bind() - basic functionality, priority, scope.", function() {
	var up = this.up, seq = [];
	var someScope = {
		prop1: 1,
		prop2: 2
	};

	up.bind('SomeEvent', function() {
		seq.push(1);
		deepEqual(this, someScope, "Scope successfully altered.");
	}, someScope, 5);

	up.bind('SomeEvent', function() {
		ok(!seq.length, "Handler with higher priority runs first.")
		seq.push(2);
	}, up, 10);

	up.bind('SomeEvent', function() {
		ok(this instanceof plupload.Uploader, "By default the scope is set to the object firing the event.");
		seq.push(3);
		return false;
	});

	up.bind('SomeEvent', function() {
		// this should never run
		ok(false, "Consequent event handlers cancelled by returning false.");
		seq.push(4);
	});

	up.bind('TestComplete', function() {
		deepEqual(seq, [2,1,3], "All expected event handlers have run and in order specified by priority.");
	});

	up.trigger('SomeEvent');
	up.trigger('TestComplete');
});


test("unbind()", function(assert) {
	var up = this.up, seq = [];

	function handler1() {
		seq.push(1);
	}

	function handler2() {
		seq.push(2);
	}

	up.bind('SomeEvent', handler1);
	up.bind('SomeEvent', handler2);

	up.trigger('SomeEvent'); // will populate seq with [1,2]

	up.unbind('SomeEvent', handler2);

	up.trigger('SomeEvent'); // seq should become [1,2,1]

	assert.deepEqual(seq, [1,2,1], "unbind successfull.");
});


test("unbindAll()", function(assert) {
	var up = this.up, seq = [];

	function handler1() {
		seq.push(1);
	}

	function handler2() {
		seq.push(2);
	}

	up.bind('SomeEvent', handler1);
	up.bind('SomeEvent', handler2);

	up.trigger('SomeEvent'); // will populate seq with [1,2]

	up.unbindAll('SomeEvent');

	up.trigger('SomeEvent'); // seq should become [1,2,1]

	assert.deepEqual(seq, [1,2], "unbind successfull.");
});


module("Events");


test('Init, PostInit', function(assert) {
	expect(5);

	var uploader = new plupload.Uploader({
		browse_button: 'qunit-fixture',
		runtimes: 'test',
		url: '../upload.php',

		preinit: {
			Init: function(up, info) {
				ok(true, "Init fired.");
				deepEqual(up, uploader, 
					"First argument is plupload.Uploader instance.");
				ok(typeof(info) === 'object' && !plupload.isEmptyObj(info), 
					"Second arguments is object.");
				equal(info.runtime, 'test', 
					"Runtime identifier passed in as second argument.");
			},

			PostInit: function() {
				start();
				ok(true, 'PostInit fired.');
			},

			Error: function() {
				start();
				ok(false, "Plupload cannot be initialized.");
			}
		}
	});

	stop();
	uploader.init();
});


test('Error (plupload.INIT_ERROR)', function(assert) {
	expect(4);

	var uploader = new plupload.Uploader({
		runtimes: 'test',
		url: '../upload.php',

		preinit: {
			Init: function() {
				ok(false, "Error fired.");
				
			},

			Error: function(up, err) {
				start();
				ok(true, "Error fired.");

				deepEqual(up, uploader, 
					"First argument is plupload.Uploader instance.");
				ok(typeof(err) === 'object' && !plupload.isEmptyObj(err), 
					"Second arguments is object.");

				equal(err.code, plupload.INIT_ERROR, 
					"Error has plupload.INIT_ERROR code");
			}
		}
	});

	stop();
	uploader.init();
});


test('Refresh', function(assert) {
	var uploader = new plupload.Uploader({
		browse_button: 'qunit-fixture',
		runtimes: 'test',
		url: '../upload.php',

		preinit: {
			PostInit: function() {
				uploader.refresh();
			},

			Error: function() {
				start();
				ok(false, "Plupload cannot be initialized.");
			}
		},

		init: {
			Refresh: function() {
				start();
				ok(true, "Refresh fired.");
			}
		}
	});

	stop();
	uploader.init();
});


test('Destroy', function(assert) {
	expect(4);

	var runtimeFiles = FileHash.getRuntimeFiles();

	var uploader = new plupload.Uploader({
		browse_button: 'qunit-fixture',
		runtimes: 'test',
		url: '../upload.php',

		preinit: {
			PostInit: function(up) {
				up.addFile(runtimeFiles);
			},

			Error: function() {
				start();
				assert.ok(false, "Plupload cannot be initialized.");
			}
		},

		init: {
			FilesAdded: function(up, files) {
				assert.ok(true, "FilesAdded fired.");
				assert.equal(files.length, 2, files.length + " files were added");

				up.destroy();
			},

			Destroy: function(up) {
				start();
				assert.ok(true, "Destroy fired.");

				// all files should be destroyed by this moment
				var allDestroyed = true;
				up.forEachItem(function(file) {
					console.info(file.state);
					if (file.state !== 8) { //  Queueable.DESTROYED = 8;
						allDestroyed = false;
					}
				});
				assert.ok(allDestroyed, "All files have been destroyed.");
			}
		}
	});

	stop();
	uploader.init();
});


test("FileFiltered, FilesAdded, QueueChanged", function() {
	expect(7);

	var events = {
		FileFiltered: 0
	};

	var runtimeFiles = FileHash.getRuntimeFiles();

	var uploader = new plupload.Uploader({
		browse_button: 'qunit-fixture',
		runtimes: 'test',
		url: '../upload.php',

		preinit: {
			PostInit: function(up) {				
				up.addFile(runtimeFiles);
			},

			Error: function() {
				start();
				ok(false, "Plupload cannot be initialized.");
			}
		},

		init: {
			FileFiltered: function(up, file) {
				if (!events.FileFiltered) {
					ok(true, "FileFiltered fired.");
					ok(file instanceof plupload.File,
							"Second argument is plupload.File instance.");
				}

				events.FileFiltered++;
			},

			FilesAdded: function(up, files) {
				start();
				equal(events.FileFiltered, 2, "FileFiltered fired 2 times.");
				ok(true, "FilesAdded fired.");

				equal(files.length, runtimeFiles.length, runtimeFiles.length + " files added to the queue.");
				ok(files[0] instanceof plupload.File,
						"Files in the queue are plupload.File instances.");
			},

			QueueChanged: function() {
				ok(true, "QueueChanged fired.");
			}
		}
	});

	stop();
	uploader.init();
});


test("FilesRemoved, QueueChanged", function() {
	expect(4);

	var events = {
		QueueChanged: 0
	}

	var runtimeFiles = FileHash.getRuntimeFiles();

	var uploader = new plupload.Uploader({
		browse_button: 'qunit-fixture',
		runtimes: 'test',
		url: '../upload.php',

		preinit: {
			PostInit: function(up) {				
				up.addFile(runtimeFiles);
			},

			Error: function() {
				start();
				ok(false, "Plupload cannot be initialized.");
			}
		},

		init: {
			FilesAdded: function(up, files) {
				up.removeFile(files[0]);
			},

			FilesRemoved: function(up, removedFiles) {
				start();
				ok(true, "FilesRemoved fired.");

				equal(events.QueueChanged, 2, "QueueChanged fired 2 times (one for file add and one for remove).");

				equal(removedFiles.length, 1, "One item in second argument.");
				equal(up.files.length, 1, "One file left in the queue.");
			},

			QueueChanged: function() {
				events.QueueChanged++;
			}
		}
	});

	stop();
	uploader.init();
});


test("StateChanged, BeforeUpload, UploadFile, UploadProgress, FileUploaded", function() {
	expect(10);

	var events = {
		StateChanged: 0,
		BeforeUpload: 0,
		UploadFile: 0,
		UploadProgress: 0,
		FileUploaded: 0,
		UploadComplete: 0
	};

	var uploader = new plupload.Uploader({
		browse_button: 'qunit-fixture',
		runtimes: 'test',
		url: '../upload.php',

		preinit: {
			Init: function(up, info) {	
				var runtimeFiles = FileHash.getRuntimeFiles(info.ruid);
				runtimeFiles[0].ruid = info.ruid; // otherwise it fails to connect to test runitme	
				runtimeFiles[0].connectRuntime(info.ruid);		
				up.addFile(runtimeFiles[0]);
			},

			Error: function() {
				start();
				ok(false, "Plupload cannot be initialized.");
			}
		},

		init: {
			FilesAdded: function(up) {
				up.start();
			},


			BeforeUpload: function(up, file) {
				events.BeforeUpload++;
				ok(file instanceof plupload.File, "Second argument in BeforeUpload handler is plupload.File instance.");
			},


			UploadFile: function(up, file) {
				events.UploadFile++;
				ok(file instanceof plupload.File, "Second argument in UploadFile handler is plupload.File instance.");
			},


			UploadProgress: function() {
				events.UploadProgress++;
			},

			FileUploaded: function() {
				events.FileUploaded++;
			},


			UploadComplete: function() {
				events.UploadComplete++;

				start();

				plupload.each(events, function(count, name) {
					ok(count > 0, name + " fired " + count + " times.");
				});
			},


			StateChanged: function(up, file) {

				switch(up.state) {
					case 1:
						ok(true, "Uploader state changed to Queue.STOPPED");
						break;

					case 2:
						ok(true, "Uploader state changed to Queue.STARTED");
						break;

					case 3:
						ok(false, "Uploader state changed to Queue.PAUSED"); // this one shouldn't fire
						break;
				}

				events.StateChanged++;
			}
		}
	});

	stop();
	uploader.init();
});


test("It should be possible to abort file upload if false is returned from BeforeUpload handler", function(assert) {
	expect(2);

	var events = {
		BeforeUpload: 0,
		UploadFile: 0
	};

	var uploader = new plupload.Uploader({
		browse_button: 'qunit-fixture',
		runtimes: 'test',
		url: '../upload.php',

		preinit: {
			Init: function(up, info) {
				var runtimeFiles = FileHash.getRuntimeFiles(info.ruid);
				runtimeFiles[0].ruid = info.ruid; // otherwise it fails to connect to test runitme
				runtimeFiles[0].connectRuntime(info.ruid);
				up.addFile(runtimeFiles[0]);
			},

			Error: function() {
				start();
				ok(false, "Plupload cannot be initialized.");
			}
		},

		init: {
			FilesAdded: function(up) {
				up.start();
			},


			BeforeUpload: function(up, file) {
				events.BeforeUpload++;
				return false;
			},


			UploadFile: function(up, file) {
				events.UploadFile++;
			},

			UploadComplete: function() {
				start();

				assert.ok(events.BeforeUpload > 0, "BeforeUpload has fired.");
				assert.equal(events.UploadFile, 0, "Upload successfully stopped by returning false from BeforeUpload.");
			}
		}
	});

	stop();
	uploader.init();
});


test("Error (HTTP error)", function() {
	expect(5);

	var uploader = new plupload.Uploader({
		browse_button: 'qunit-fixture',
		runtimes: 'test',
		url: '404',

		preinit: {
			Init: function(up, info) {	
				var runtimeFiles = FileHash.getRuntimeFiles(info.ruid);
				runtimeFiles[0].ruid = info.ruid; // otherwise it fails to connect to test runitme	
				runtimeFiles[0].connectRuntime(info.ruid);	
				up.addFile(runtimeFiles[0]);
			}
		},

		init: {
			FilesAdded: function(up) {
				up.start();
			},

			CancelUpload: function() {
				ok(true, "CancelUpload fired.");
			},

			Error: function(up, err) {
				start();
				ok(true, "Error fired.");
				equal(err.code, plupload.HTTP_ERROR, "Error code is plupload.HTTP_ERROR.");
				equal(err.message, plupload.translate('HTTP Error.'), "Error message is present");
				ok(err.file instanceof plupload.File, "Erroneous file passed as property of error object.");
			}
		}
	});

	stop();
	uploader.init();
});

/**	
@event OptionChanged
@event Browse
@event ChunkUploaded
*/


</script>
</head>
<body>
	<div id="qunit"></div>
    <div id="qunit-fixture" style="position: relative; top: 0 !important; left: 0 !important; width: 100%; height: 9px;"></div>
</body>
</html>